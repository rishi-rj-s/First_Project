<%- include('../partials/loginheader') -%>

     <body>

          <nav class="py-3 bg-black  text-left w-full fixed top-0">
               <h1 class="text-white pl-2 text-4xl font-black">RISHI STUDIO</h1>
          </nav>

          <div class="flex mt-11 text-white fixed justify-end items-center w-full">
               <a href="/" class="text-sm bg-black px-2 border-2 border-white">
                    <i class="fa-solid fa-circle-user mr-2"></i>
                    BACK
               </a>
          </div>

          <div class="flex justify-center items-center mt-5 pt-16">
               <div class="inline-block bg-slate-300 px-3 p-1">
                    <h1 class="text-4xl font-bold font-mono">OTP Verify</h1>
               </div>
          </div>

          <div class="flex justify-center mt-4">
               <form action="/user/checkotp" method="post" onsubmit="return validateForm()">
                    <div class="flex flex-col gap-y-2 rounded-2xl bg-slate-300 px-3 py-2">
                         <div class="flex flex-col gap-y-2 rounded-2xl bg-slate-300 px-3 py-2">
                              <label for="otp" class="mb-1">OTP</label>
                              <input type="text" name="otp" class="h-8 w-64 border border-gray-700" required>
                              <div id="timer" class="text-gray-600 ml-2"></div>
                         </div>
                    </div>
                    <div class="flex justify-center items-center mt-4">
                         <input type="submit"
                              class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded"
                              name="submit" id="registerButton" value="Verify">
                         <button type="button"
                              class="bg-blue-500 hover:bg-blue-700 text-white font-bold rounded px-2 py-2 ml-2"
                              id="resendButton" style="display:none;">Resend OTP</button>
                    </div>
               </form>
          </div>

          <script>

               let msg = "<%= locals.msg %>";
               if (msg == "send") {
                    Swal.fire({
                         title: 'Success!',
                         text: 'OTP sent successfully!',
                         icon: 'success',
                         confirmButtonText: 'OK'
                    })
               }
               // Function to calculate remaining time
               function calculateRemainingTime(timestamp) {
                    const currentTime = Date.now();
                    const elapsedTime = (currentTime - timestamp) / 1000; // Convert to seconds
                    const remainingTime = Math.max(0, 60 - elapsedTime); // Maximum time is 60 seconds
                    return formatTime(remainingTime);
               }

               // Function to format time
               function formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = Math.floor(seconds % 60);
                    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
               }

               // Function to update timer
               function updateTimer() {
                    const timerElement = document.getElementById('timer');
                    const remainingTime = calculateRemainingTime(startTime);
                    timerElement.textContent = remainingTime;
                    if (remainingTime === '0:00') {
                         clearInterval(timerInterval);
                         document.getElementById('resendButton').style.display = 'flex'; // Show the resend container
                         document.getElementById('registerButton').style.display = 'none'; // Hide the register button
                    } else {
                         document.getElementById('registerButton').style.display = 'flex'; // Show the register button
                    }
               }

               // Set the start time
               let startTime = Date.now();

               // Update the timer every second
               let timerInterval = setInterval(updateTimer, 1000);

               // Event listener for resend button click
               document.getElementById('resendButton').addEventListener('click', function () {
                    resendOtp();
                    document.getElementById('resendButton').style.display = 'none';
               })

               // Function to handle resending OTP via AJAX
               function resendOtp() {
                    fetch('/user/resendotp', {
                         method: 'GET',
                         headers: {
                              'Content-Type': 'application/json'
                         }
                    })
                         .then(response => {
                              if (response.ok) {
                                   Swal.fire({
                                        title: 'Success!',
                                        text: 'OTP sent successfully',
                                        icon: 'success',
                                        confirmButtonText: 'OK'
                                   });
                              } else {
                                   throw new Error('Failed to resend OTP');
                              }
                              // Reset the start time
                              startTime = Date.now();
                              // Restart the timer
                              clearInterval(timerInterval);
                              timerInterval = setInterval(updateTimer, 1000);
                         })
                         .catch(error => {
                              console.error(error);
                              Swal.fire({
                                   title: 'Error!',
                                   text: 'Failed to resend OTP',
                                   icon: 'error',
                                   confirmButtonText: 'OK'
                              });
                              // Show the resend button again on failure
                              document.getElementById('resendButton').style.display = 'flex';
                         });
               }

               // Function to validate form
               function validateForm() {
                    const otp = document.querySelector('[name="otp"]');

                    // Check if any field is empty or contains only whitespace
                    if (!otp.value.trim()) {
                         Swal.fire({
                              title: 'Error!',
                              text: 'OTP is empty',
                              icon: 'error',
                              confirmButton: 'Retry'
                         });
                         return false; // Prevent form submission
                    }

                    return true; // Allow form submission
               }
          </script>
          <script>
               const urlParams = new URLSearchParams(window.location.search);
               const error = urlParams.get('error');

               if (typeof error !== 'undefined') {
                    if (error.includes('otpwrong')) {
                         Swal.fire({
                              title: 'Error!',
                              text: 'WRONG OTP!',
                              icon: 'error',
                              confirmButtonText: 'OK'
                         })
                         window.history.replaceState({}, document.title, window.location.pathname);
                    } else if (error.includes('expired')) {
                         Swal.fire({
                              title: 'Error!',
                              text: 'OTP Expired!',
                              icon: 'error',
                              confirmButtonText: 'OK'
                         })
                         window.history.replaceState({}, document.title, window.location.pathname);
                         clearInterval(timerInterval); // Stop the timer
                         document.getElementById('resendButton').style.display = 'flex'; // Show the resend container
                         document.getElementById('registerButton').style.display = 'none'; // Hide the register button
                    } else if (error.includes('unable')) {
                         Swal.fire({
                              title: 'Error!',
                              text: 'Unable to send OTP!',
                              icon: 'error',
                              confirmButtonText: 'OK'
                         })
                         window.history.replaceState({}, document.title, window.location.pathname);
                    }
               }

          </script>
     </body>

     </html>