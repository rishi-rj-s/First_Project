<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RISHI STUDIO</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.0/dist/sweetalert2.all.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
      }

      .container {
        margin-top: 50px;
      }

      .order-details,
      .address-selection,
      .payment-method,
      .total-amount {
        background-color: #fff;
        padding: 20px;
        margin-top: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .btn-place-order {
        margin-top: 20px;
      }

      .object-fit-cover {
        object-fit: cover;
        height: 150px;
        width: 150px;
      }

      .custom-width input {
        width: 150px !important;
      }

      .banner-wrapper {
        background-color: black;
        padding: 10px;
      }

      .banner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .banner h1 {
        font-family: Impact, Haettenschweiler, "Arial Narrow Bold", sans-serif;
        padding-left: 10px;
        margin-top: 0;
        color: white;
      }

      .icons {
        align-items: center;
      }

      .icons a {
        margin-right: 10px;
      }

      @media (min-width: 768px) {
        .banner h1 {
          margin-bottom: 0;
        }

        .form-outline-inline input[type="search"] {
          width: auto;
          margin-right: 0;
        }
      }

      .banner .fa-heart {
        color: red !important;
      }

      .banner .fa-shopping-cart {
        color: orange !important;
      }

      .banner .fa-user {
        color: Teal !important;
      }

      .icons i {
        font-size: 30px;
      }
    </style>
  </head>

  <body>
    <div class="banner-wrapper fixed-top">
      <div class="banner">
        <a href="/"><h1 class="title">RISHI STUDIO</h1></a>
        <!-- <form class="form-outline-inline" action="/product/search" method="get" required>
                  <input type="search" id="form1" class="form-control" placeholder="Search" />
                  <button type="submit" class="btn btn-primary shadow-0">
                      <i class="fa fa-search"></i>
                  </button>
              </form> -->
        <div class="icons" style="z-index: 99">
          <a href="/user/cart"><i class="fa fa-shopping-cart"></i></a>
          <a href="/user/wishlist"><i class="fa fa-heart"></i></a>
          <a href="/user/profile"><i class="fa fa-user"></i></a>
          <a href="/user/logout"><i class="fa fa-power-off"></i></a>
        </div>
      </div>
    </div>

    <div class="container" style="margin-top: 8rem">
      <h1 class="text-center mb-4">Cart</h1>
        <div class="row">
          <div class="col-md-8 mx-auto">
            <!-- Order Details -->
            <div class="order-details">
              <h3>Products</h3>
              <hr />
              <div class="cart-items">
                <div
                  class="cart-items-container"
                  style="max-height: 400px; overflow-y: auto"
                >
                  <% usercart.forEach(cartItem=> { %> <%
                  cartItem.product.forEach(product=> { %>

                  <div
                    class="card"
                    data-product-id="<%= product.productId._id %>"
                  >
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-md-4">
                          <img
                            src="/<%= product.productId.images[0] %>"
                            alt="Product Image"
                            class="img-fluid object-fit-cover"
                          />
                        </div>
                        <div class="col-md-8">
                          <h4 class="card-title">
                            <%= product.productId.p_name %>
                          </h4>
                          <br />
                          <h5>
                            $<%=
                            (product.productId.total_price)*(product.quantity)
                            %>
                          </h5>
                          <% if (product.productId.stock> 0) { %>
                          <div class="custom-width">
                            <div class="input-group me-2">
                              <!-- <button class="btn btn-outline-secondary decrement-btn" type="button" onclick="updateQuantity('<%= product.productId._id %>', <%= product.price %>, 'decrement')">-</button> -->
                              <input
                                type="text"
                                class="form-control quantity-input"
                                value="<%= product.quantity %>"
                                aria-label="Quantity"
                                readonly
                                data-product-id="<%= product.productId._id %>"
                              />
                              <!-- <button class="btn btn-outline-secondary increment-btn" type="button" onclick="updateQuantity('<%= product.productId._id %>', <%= product.price %>, 'increment')">+</button> -->
                            </div>
                          </div>
                          <% } else { %>
                          <!-- If the product is out of stock -->
                          <div class="text-danger">Out of Stock</div>
                          <!-- Disable buy button -->
                          <script>
                            document.getElementById(
                              "placeOrderBtn"
                            ).disabled = true;
                          </script>
                          <% } %>
                          <br>
                          <button class="btn btn-danger delete" data-id="<%= product.productId._id %>">
                              <i class="fas fa-trash"></i> Remove
                          </button>
                          <% if (product.productId.discount) { %>
                          <div class="d-flex">
                            Discount:
                            <p class="text-success">
                              &emsp13; <%= product.productId.discount %>%
                            </p>
                          </div>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% }); %> <% }); %>
                </div>
              </div>
              
              <script>
               const deleteButtons = document.querySelectorAll(".delete");
               deleteButtons.forEach(function (button) {
                   button.addEventListener("click", function () {
                       const productId = this.getAttribute("data-id");
       
                       // Display SweetAlert confirmation dialog
                       Swal.fire({
                           title: "Are you sure?",
                           text: "You won't be able to revert this!",
                           icon: "warning",
                           showCancelButton: true,
                           confirmButtonColor: "#3085d6",
                           cancelButtonColor: "#d33",
                           confirmButtonText: "Yes, delete it!"
                       }).then((result) => {
                           if (result.isConfirmed) {
                               // User confirmed deletion, send request to delete address
                               fetch(`/user/removecart/${productId}`, {
                                   method: "GET"
                               })
                                   .then(response => {
                                       if (response.ok) {
                                           // Show success message using SweetAlert
                                           Swal.fire({
                                               title: "Removed!",
                                               text: "Product has been removed.",
                                               icon: "success"
                                           }).then(() => {
                                               // Reload the page
                                               window.location.reload();
                                           });
                                       } else {
                                           // Failed to delete address
                                           console.error("Failed to delete address");
                                           // Show error message using SweetAlert
                                           Swal.fire({
                                               title: "Failed!",
                                               text: "Product cannot be removed.",
                                               icon: "error"
                                           });
                                       }
                                   })
       
                                   .catch(error => {
                                       console.error("Error:", error);
                                       // Show error message using SweetAlert
                                       Swal.fire({
                                           title: "Error!",
                                           text: "An error occurred while removing the product.",
                                           icon: "error"
                                       });
                                   });
                           }
                       });
                   });
               });
           </script>

            </div>
            <!-- Total Amount -->
            <div class="total-amount">
              <h3>Grand Total</h3>
              <hr />
              <p><strong>Total Amount: <%= subtotal %></strong></p>
            </div>
            <div class="d-flex justify-content-center mb-5">
              <!-- Place Order Button -->
              <a href="/user/orders"><button
                style="width: 200px"
                class="btn btn-primary btn-block btn-place-order"
                id="placeOrderBtn"
              >
                Buy
              </button></a>
            </div>
          </div>
        </div>
    </div>


    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const incrementBtns = document.querySelectorAll(".increment-btn");
        const decrementBtns = document.querySelectorAll(".decrement-btn");
        const quantityInputs = document.querySelectorAll(".quantity-input");

        incrementBtns.forEach(function (btn, index) {
          btn.addEventListener("click", function () {
            quantityInputs[index].value =
              parseInt(quantityInputs[index].value) + 1;
          });
        });

        decrementBtns.forEach(function (btn, index) {
          btn.addEventListener("click", function () {
            const currentValue = parseInt(quantityInputs[index].value);
            if (currentValue > 1) {
              quantityInputs[index].value = currentValue - 1;
            }
          });
        });
      });
    </script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const message = urlParams.get("msg"); // Change 'message' to 'msg'
      if (typeof message !== "undefined") {
        if (message.includes("nostock")) {
          Swal.fire({
            title: "Error",
            text: "No stock available!",
            icon: "error",
            confirmButtonText: "OK",
          });
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
        } else if (message.includes("addcart")) {
          Swal.fire({
            title: "Success",
            text: "Successfully added to cart",
            icon: "success",
            confirmButtonText: "OK",
          });
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
        } else if (message.includes("error")) {
          Swal.fire({
            title: "Failure",
            text: "Error Occured",
            icon: "error",
            confirmButtonText: "OK",
          });
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
        } else if (message.includes("exists")) {
          Swal.fire({
            title: "Exists",
            text: "Items exists in cart!",
            icon: "error",
            confirmButtonText: "OK",
          });
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
        }
      }
    </script>

    <%- include('footer')%>
  </body>
</html>
